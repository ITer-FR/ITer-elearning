# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Frontend pull request workflow
"on": pull_request
jobs:
  frontend-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v2

      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Install packages
        run: cd frontend && npm ci

      - name: Unit tests
        run: cd frontend && npm run test:unit

      - name: Integration tests
        run: cd frontend && npm install firebase && npm run test:integration

      - name: Install backend packages
        run: cd backend && npm ci

      - name: Install functions packages
        run: cd backend/functions && npm ci

      - uses: cypress-io/github-action@v2
        with:
          start: npm run start:e2e
          install: false
          wait-on: "http://localhost:3000"
          wait-on-timeout: 20
          browser: chrome
          headless: true
          working-directory: frontend

      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots
